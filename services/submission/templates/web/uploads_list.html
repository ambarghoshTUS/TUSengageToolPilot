<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Uploads - TUS-Engage Data Submission Portal</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/upload.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(90deg, #000000, #a39461);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-university me-2"></i>
                TUS-Engage Data Submission Portal
            </a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/upload">
                    <i class="fas fa-upload me-1"></i>
                    Upload
                </a>
                <a class="nav-link active" href="/uploads">
                    <i class="fas fa-list me-1"></i>
                    My Uploads
                </a>
            </div>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>
                    Welcome, {{ user_name or 'User' }}
                </span>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-list me-2"></i>
                        My Uploads
                    </h2>
                    <a href="/upload" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        New Upload
                    </a>
                </div>

                <!-- Filters -->
                <div class="card shadow mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select id="statusFilter" class="form-select">
                                    <option value="">All Statuses</option>
                                    <option value="completed">Completed</option>
                                    <option value="processing">Processing</option>
                                    <option value="failed">Failed</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="dateFilter" class="form-label">Date Range</label>
                                <select id="dateFilter" class="form-select">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="searchFilter" class="form-label">Search</label>
                                <input type="text" id="searchFilter" class="form-control" 
                                       placeholder="Search by filename...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button id="refreshBtn" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-refresh me-1"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Uploads Table -->
                <div class="card shadow">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Upload History</h5>
                            <span id="resultsCount" class="text-muted">Loading...</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>File Name</th>
                                        <th>Upload Date</th>
                                        <th>Size</th>
                                        <th>Status</th>
                                        <th>Records</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="uploadsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border me-2"></div>
                                            Loading uploads...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> 
                                of <span id="totalCount">0</span> uploads
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination">
                                    <!-- Pagination will be generated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Upload Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detailsContent">
                        <div class="text-center py-3">
                            <div class="spinner-border me-2"></div>
                            Loading details...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class UploadsManager {
            constructor() {
                this.currentPage = 1;
                this.pageSize = 10;
                this.totalCount = 0;
                this.filters = {
                    status: '',
                    date: '',
                    search: ''
                };
                
                this.init();
                this.loadUploads();
            }

            init() {
                // Setup event listeners
                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.currentPage = 1;
                    this.loadUploads();
                });

                document.getElementById('dateFilter').addEventListener('change', (e) => {
                    this.filters.date = e.target.value;
                    this.currentPage = 1;
                    this.loadUploads();
                });

                document.getElementById('searchFilter').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.currentPage = 1;
                    this.debounceSearch();
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadUploads();
                });
            }

            debounceSearch() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.loadUploads();
                }, 300);
            }

            async loadUploads() {
                const tbody = document.getElementById('uploadsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border me-2"></div>
                            Loading uploads...
                        </td>
                    </tr>
                `;

                try {
                    const params = new URLSearchParams({
                        limit: this.pageSize,
                        offset: (this.currentPage - 1) * this.pageSize
                    });

                    if (this.filters.status) {
                        params.append('status', this.filters.status);
                    }

                    const response = await fetch(`/api/submission/uploads?${params}`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.renderUploads(data);
                        this.updatePagination(data);
                    } else {
                        throw new Error('Failed to load uploads');
                    }
                } catch (error) {
                    console.error('Error loading uploads:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading uploads. Please try again.
                            </td>
                        </tr>
                    `;
                }
            }

            renderUploads(data) {
                const tbody = document.getElementById('uploadsTableBody');
                const uploads = data.uploads || [];

                if (uploads.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="fas fa-inbox me-2"></i>
                                No uploads found
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = uploads.map(upload => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-${this.getFileIcon(upload.original_filename)} file-icon me-2"></i>
                                <div>
                                    <div class="fw-bold">${upload.original_filename}</div>
                                    <small class="text-muted">${upload.file_type?.toUpperCase() || 'Unknown'}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${new Date(upload.uploaded_at).toLocaleDateString()}</div>
                            <small class="text-muted">${new Date(upload.uploaded_at).toLocaleTimeString()}</small>
                        </td>
                        <td>${this.formatFileSize(upload.file_size)}</td>
                        <td>
                            <span class="badge bg-${this.getStatusColor(upload.upload_status)}">
                                ${upload.upload_status}
                            </span>
                        </td>
                        <td>
                            <div>${upload.rows_processed || 0} processed</div>
                            ${upload.rows_failed ? `<small class="text-danger">${upload.rows_failed} failed</small>` : ''}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="uploadsManager.viewDetails('${upload.file_id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${upload.upload_status === 'completed' ? `
                                    <button class="btn btn-outline-success" onclick="uploadsManager.downloadData('${upload.file_id}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Update results count
                document.getElementById('resultsCount').textContent = `${data.total} uploads found`;
            }

            updatePagination(data) {
                this.totalCount = data.total;
                const totalPages = Math.ceil(this.totalCount / this.pageSize);
                
                // Update showing counts
                const start = (this.currentPage - 1) * this.pageSize + 1;
                const end = Math.min(this.currentPage * this.pageSize, this.totalCount);
                
                document.getElementById('showingStart').textContent = start;
                document.getElementById('showingEnd').textContent = end;
                document.getElementById('totalCount').textContent = this.totalCount;

                // Generate pagination
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';

                if (totalPages <= 1) return;

                // Previous button
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="uploadsManager.goToPage(${this.currentPage - 1})">Previous</a>`;
                pagination.appendChild(prevLi);

                // Page numbers
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);

                for (let i = startPage; i <= endPage; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#" onclick="uploadsManager.goToPage(${i})">${i}</a>`;
                    pagination.appendChild(pageLi);
                }

                // Next button
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${this.currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="uploadsManager.goToPage(${this.currentPage + 1})">Next</a>`;
                pagination.appendChild(nextLi);
            }

            goToPage(page) {
                this.currentPage = page;
                this.loadUploads();
            }

            async viewDetails(fileId) {
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                const content = document.getElementById('detailsContent');
                
                content.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border me-2"></div>
                        Loading details...
                    </div>
                `;
                
                modal.show();

                try {
                    const response = await fetch(`/api/submission/uploads/${fileId}`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.renderDetails(data.upload);
                    } else {
                        throw new Error('Failed to load details');
                    }
                } catch (error) {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading upload details.
                        </div>
                    `;
                }
            }

            renderDetails(upload) {
                const content = document.getElementById('detailsContent');
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>File Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Filename:</strong></td>
                                    <td>${upload.original_filename}</td>
                                </tr>
                                <tr>
                                    <td><strong>Size:</strong></td>
                                    <td>${this.formatFileSize(upload.file_size)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Type:</strong></td>
                                    <td>${upload.file_type?.toUpperCase() || 'Unknown'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Uploaded:</strong></td>
                                    <td>${new Date(upload.uploaded_at).toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Processing Results</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        <span class="badge bg-${this.getStatusColor(upload.upload_status)}">
                                            ${upload.upload_status}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Records Processed:</strong></td>
                                    <td>${upload.rows_processed || 0}</td>
                                </tr>
                                <tr>
                                    <td><strong>Records Failed:</strong></td>
                                    <td>${upload.rows_failed || 0}</td>
                                </tr>
                                <tr>
                                    <td><strong>Data Records:</strong></td>
                                    <td>${upload.data_records || 0}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    ${upload.error_message ? `
                        <div class="mt-3">
                            <h6>Error Details</h6>
                            <div class="alert alert-danger">
                                ${upload.error_message}
                            </div>
                        </div>
                    ` : ''}
                    ${upload.validation_notes ? `
                        <div class="mt-3">
                            <h6>Validation Notes</h6>
                            <div class="alert alert-info">
                                ${upload.validation_notes}
                            </div>
                        </div>
                    ` : ''}
                `;
            }

            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                switch (ext) {
                    case 'xlsx':
                    case 'xls':
                        return 'excel';
                    case 'csv':
                        return 'csv';
                    case 'tsv':
                        return 'alt';
                    default:
                        return 'alt';
                }
            }

            getStatusColor(status) {
                switch (status) {
                    case 'completed':
                        return 'success';
                    case 'processing':
                        return 'warning';
                    case 'failed':
                        return 'danger';
                    case 'pending':
                        return 'info';
                    default:
                        return 'secondary';
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            getAuthToken() {
                return localStorage.getItem('jwt_token') || 'demo_token';
            }
        }

        // Initialize when DOM is loaded
        let uploadsManager;
        document.addEventListener('DOMContentLoaded', () => {
            uploadsManager = new UploadsManager();
        });
    </script>
</body>
</html>